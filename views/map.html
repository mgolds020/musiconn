<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      #map {
        width: calc(100% - 280px);
        height: 100vh;
        margin-left: 280px;
      }
      #sidebar {
        position: absolute;
        top: 0;
        left: 0;
        width: 280px;
        height: 100vh;
        overflow: auto;
        background: white;
        z-index: 1000;
        border-right: 1px solid #e5e5e5;
      }

      .sidebar-item {
        display: block;
        width: 100%;
        padding: 12px;
        text-align: left;
        border: 0;
        background: transparent;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .sidebar-item:hover {
        background: #f7f7f7;
      }

      .sidebar-title {
        font-weight: 600;
      }

      .sidebar-meta {
        font-size: 12px;
        margin-top: 4px;
      }

      #map-search-overlay {
        position: absolute;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        z-index: 1100;
      }

      #map-search-btn {
        padding: 12px 18px;
        border-radius: 999px;
        border: 1px solid #ccc;
        background: #f4f4f4;
        font-size: 14px;
        cursor: not-allowed;
      }

      #map-search-btn.enabled {
        background: white;
        cursor: pointer;
      }

      #locate-btn {
        position: absolute;
        right: 20px;
        bottom: 24px;
        z-index: 1100;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #locate-btn:hover {
        background: #f7f7f7;
      }


    </style>
  </head>

  <body>
    <div id="sidebar"></div>

    <div id="map-search-overlay">
      <button id="map-search-btn" disabled>
        Search this location
      </button>
    </div>

    <div id="locate-btn" title="Go to my location">
      üìç
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      const map = L.map("map");

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { attribution: "¬© OpenStreetMap contributors ¬© CARTO" }
      ).addTo(map);

      const sidebar = document.getElementById("sidebar");

      const searchBtn = document.getElementById("map-search-btn");
      const MAX_RADIUS_MILES = 40;

      const locateBtn = document.getElementById("locate-btn");

      // Keep track of what we've drawn so we can clear it
      let activeMarkers = [];
      let activeBounds = [];

      function clearResults() {
        // remove markers from map
        activeMarkers.forEach(m => map.removeLayer(m));
        activeMarkers = [];
        activeBounds = [];

        // clear sidebar (keep it simple: wipe everything)
        sidebar.innerHTML = "";
      }

      function formatPrice(post) {
        const low = Number(post.priceLowBound ?? 0);
        const high = Number(post.priceHighBound ?? 0);

        if (low === 0 && high === 0) return "Free";
        if (low === high) return `$${low}`;
        return `$${low}‚Äì$${high}`;
      }

      function renderPosts(posts) {
        clearResults();

        for (const post of posts) {
          const coords = post?.location?.coordinates;
          if (!coords || coords.length !== 2) continue;

          const [lng, lat] = coords;
          if (!Number.isFinite(lng) || !Number.isFinite(lat)) continue;

          const latlng = [lat, lng];
          activeBounds.push(latlng);

          const marker = L.circleMarker(latlng, {
            radius: 8,
            weight: 2,
          }).addTo(map);

          activeMarkers.push(marker);

          const priceText = formatPrice(post);

          const title = post.title ?? "(untitled)";
          const type = post.type ?? "";
          const address = post.address ?? "";
          const description = post.description ?? "";

          const eventDate = post.eventDate ? new Date(post.eventDate).toLocaleString() : "";
          const datePosted = post.datePosted ? new Date(post.datePosted).toLocaleDateString() : "";

          marker.bindPopup(`
            <div>
              <strong>${title}</strong>
              <div>${address}</div>

              <div style="margin-top: 6px;">
                ${description}
              </div>

              <div style="margin-top: 6px;">
                ${eventDate ? `<div>Event date: ${eventDate}</div>` : ""}
                ${datePosted ? `<div>Posted: ${datePosted}</div>` : ""}
              </div>

              <div style="margin-top: 6px;">
                Price: ${priceText}
              </div>
            </div>
          `);

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "sidebar-item";
          btn.innerHTML = `
            <div class="sidebar-title">${title}</div>
            <div class="sidebar-meta">${type}${address ? ` ‚Ä¢ ${address}` : ""}</div>
          `;

          btn.addEventListener("click", () => {
            map.setView(latlng, 14);
            marker.openPopup();
          });

          sidebar.appendChild(btn);
        }

        if (activeBounds.length === 1) {
          map.setView(activeBounds[0], 14);
        } else if (activeBounds.length > 1) {
          map.fitBounds(activeBounds);
        }

        updateSearchButtonState();
      }

      locateBtn.addEventListener("click", () => {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 13);
          },
          () => alert("Unable to retrieve your location."),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });

      function currentRadiusMiles() {
        const b = map.getBounds();
        const c = map.getCenter();
        const northPoint = L.latLng(b.getNorth(), c.lng);
        const meters = map.distance(c, northPoint);
        return meters / 1609.344;
      }

      function updateSearchButtonState() {
        if (!map._loaded) return;
        const enabled = currentRadiusMiles() <= MAX_RADIUS_MILES;
        searchBtn.disabled = !enabled;
        searchBtn.classList.toggle("enabled", enabled);
      }

      searchBtn.addEventListener("click", async () => {
        if (searchBtn.disabled) return;

        const center = map.getCenter();

        // radius based on current map view, clamped to max
        const radiusMiles = Math.min(
          currentRadiusMiles(),
          MAX_RADIUS_MILES
        );

        try {
          const res = await fetch("/map", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              location: {
                type: "Point",
                coordinates: [center.lng, center.lat] // [lon, lat]
              },
              distanceMiles: radiusMiles
            })
          });

          const data = await res.json();
          if (!res.ok) {
            console.error("Search failed:", data);
            return;
          }

          renderPosts(Array.isArray(data) ? data : []);
        } catch (err) {
          console.error(err);
        }
      });

      map.on("moveend", updateSearchButtonState);
      map.on("zoomend", updateSearchButtonState);

      // Initial view (so map isn't blank)
      map.setView([42.3601, -71.0589], 11); // Boston-ish
      updateSearchButtonState();
    </script>

  </body>
</html>
